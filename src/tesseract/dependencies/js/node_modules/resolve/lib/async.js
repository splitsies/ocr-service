var fs=require("fs"),getHomedir=require("./homedir"),path=require("path"),caller=require("./caller"),nodeModulesPaths=require("./node-modules-paths"),normalizeOptions=require("./normalize-options"),isCore=require("is-core-module"),realpathFS="win32"!==process.platform&&fs.realpath&&"function"==typeof fs.realpath.native?fs.realpath.native:fs.realpath,homedir=getHomedir(),defaultPaths=function(){return[path.join(homedir,".node_modules"),path.join(homedir,".node_libraries")]},defaultIsFile=function(file,cb){fs.stat(file,(function(err,stat){return err?"ENOENT"===err.code||"ENOTDIR"===err.code?cb(null,!1):cb(err):cb(null,stat.isFile()||stat.isFIFO())}))},defaultIsDir=function(dir,cb){fs.stat(dir,(function(err,stat){return err?"ENOENT"===err.code||"ENOTDIR"===err.code?cb(null,!1):cb(err):cb(null,stat.isDirectory())}))},defaultRealpath=function(x,cb){realpathFS(x,(function(realpathErr,realPath){realpathErr&&"ENOENT"!==realpathErr.code?cb(realpathErr):cb(null,realpathErr?x:realPath)}))},maybeRealpath=function(realpath,x,opts,cb){opts&&!1===opts.preserveSymlinks?realpath(x,cb):cb(null,x)},defaultReadPackage=function(readFile,pkgfile,cb){readFile(pkgfile,(function(readFileErr,body){if(readFileErr)cb(readFileErr);else try{var pkg=JSON.parse(body);cb(null,pkg)}catch(jsonErr){cb(null)}}))},getPackageCandidates=function(x,start,opts){for(var dirs=nodeModulesPaths(start,opts,x),i=0;i<dirs.length;i++)dirs[i]=path.join(dirs[i],x);return dirs};module.exports=function(x,options,callback){var cb=callback,opts=options;if("function"==typeof options&&(cb=opts,opts={}),"string"!=typeof x){var err=new TypeError("Path must be a string.");return process.nextTick((function(){cb(err)}))}var isFile=(opts=normalizeOptions(x,opts)).isFile||defaultIsFile,isDirectory=opts.isDirectory||defaultIsDir,readFile=opts.readFile||fs.readFile,realpath=opts.realpath||defaultRealpath,readPackage=opts.readPackage||defaultReadPackage;if(opts.readFile&&opts.readPackage){var conflictErr=new TypeError("`readFile` and `readPackage` are mutually exclusive.");return process.nextTick((function(){cb(conflictErr)}))}var packageIterator=opts.packageIterator,extensions=opts.extensions||[".js"],includeCoreModules=!1!==opts.includeCoreModules,basedir=opts.basedir||path.dirname(caller()),parent=opts.filename||basedir;opts.paths=opts.paths||defaultPaths();var res,absoluteStart=path.resolve(basedir);function init(basedir){if(/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[/\\])/.test(x))res=path.resolve(basedir,x),"."!==x&&".."!==x&&"/"!==x.slice(-1)||(res+="/"),/\/$/.test(x)&&res===basedir?loadAsDirectory(res,opts.package,onfile):loadAsFile(res,opts.package,onfile);else{if(includeCoreModules&&isCore(x))return cb(null,x);loadNodeModules(x,basedir,(function(err,n,pkg){if(err)cb(err);else{if(n)return maybeRealpath(realpath,n,opts,(function(err,realN){err?cb(err):cb(null,realN,pkg)}));var moduleError=new Error("Cannot find module '"+x+"' from '"+parent+"'");moduleError.code="MODULE_NOT_FOUND",cb(moduleError)}}))}}function onfile(err,m,pkg){err?cb(err):m?cb(null,m,pkg):loadAsDirectory(res,(function(err,d,pkg){if(err)cb(err);else if(d)maybeRealpath(realpath,d,opts,(function(err,realD){err?cb(err):cb(null,realD,pkg)}));else{var moduleError=new Error("Cannot find module '"+x+"' from '"+parent+"'");moduleError.code="MODULE_NOT_FOUND",cb(moduleError)}}))}function loadAsFile(x,thePackage,callback){var loadAsFilePackage=thePackage,cb=callback;function load(exts,x,loadPackage){if(0===exts.length)return cb(null,void 0,loadPackage);var file=x+exts[0],pkg=loadPackage;function onpkg(err,pkg_,dir){if(pkg=pkg_,err)return cb(err);if(dir&&pkg&&opts.pathFilter){var rfile=path.relative(dir,file),rel=rfile.slice(0,rfile.length-exts[0].length),r=opts.pathFilter(pkg,x,rel);if(r)return load([""].concat(extensions.slice()),path.resolve(dir,r),pkg)}isFile(file,onex)}function onex(err,ex){return err?cb(err):ex?cb(null,file,pkg):void load(exts.slice(1),x,pkg)}pkg?onpkg(null,pkg):loadpkg(path.dirname(file),onpkg)}"function"==typeof loadAsFilePackage&&(cb=loadAsFilePackage,loadAsFilePackage=void 0),load([""].concat(extensions),x,loadAsFilePackage)}function loadpkg(dir,cb){return""===dir||"/"===dir||"win32"===process.platform&&/^\w:[/\\]*$/.test(dir)||/[/\\]node_modules[/\\]*$/.test(dir)?cb(null):void maybeRealpath(realpath,dir,opts,(function(unwrapErr,pkgdir){if(unwrapErr)return loadpkg(path.dirname(dir),cb);var pkgfile=path.join(pkgdir,"package.json");isFile(pkgfile,(function(err,ex){if(!ex)return loadpkg(path.dirname(dir),cb);readPackage(readFile,pkgfile,(function(err,pkgParam){err&&cb(err);var pkg=pkgParam;pkg&&opts.packageFilter&&(pkg=opts.packageFilter(pkg,pkgfile)),cb(null,pkg,dir)}))}))}))}function loadAsDirectory(x,loadAsDirectoryPackage,callback){var cb=callback,fpkg=loadAsDirectoryPackage;"function"==typeof fpkg&&(cb=fpkg,fpkg=opts.package),maybeRealpath(realpath,x,opts,(function(unwrapErr,pkgdir){if(unwrapErr)return cb(unwrapErr);var pkgfile=path.join(pkgdir,"package.json");isFile(pkgfile,(function(err,ex){return err?cb(err):ex?void readPackage(readFile,pkgfile,(function(err,pkgParam){if(err)return cb(err);var pkg=pkgParam;if(pkg&&opts.packageFilter&&(pkg=opts.packageFilter(pkg,pkgfile)),pkg&&pkg.main){if("string"!=typeof pkg.main){var mainError=new TypeError("package “"+pkg.name+"” `main` must be a string");return mainError.code="INVALID_PACKAGE_MAIN",cb(mainError)}return"."!==pkg.main&&"./"!==pkg.main||(pkg.main="index"),void loadAsFile(path.resolve(x,pkg.main),pkg,(function(err,m,pkg){return err?cb(err):m?cb(null,m,pkg):pkg?void loadAsDirectory(path.resolve(x,pkg.main),pkg,(function(err,n,pkg){return err?cb(err):n?cb(null,n,pkg):void loadAsFile(path.join(x,"index"),pkg,cb)})):loadAsFile(path.join(x,"index"),pkg,cb)}))}loadAsFile(path.join(x,"/index"),pkg,cb)})):loadAsFile(path.join(x,"index"),fpkg,cb)}))}))}function processDirs(cb,dirs){if(0===dirs.length)return cb(null,void 0);var dir=dirs[0];function isdir(err,isdir){return err?cb(err):isdir?void loadAsFile(dir,opts.package,onfile):processDirs(cb,dirs.slice(1))}function onfile(err,m,pkg){return err?cb(err):m?cb(null,m,pkg):void loadAsDirectory(dir,opts.package,ondir)}function ondir(err,n,pkg){return err?cb(err):n?cb(null,n,pkg):void processDirs(cb,dirs.slice(1))}isDirectory(path.dirname(dir),isdir)}function loadNodeModules(x,start,cb){var thunk=function(){return getPackageCandidates(x,start,opts)};processDirs(cb,packageIterator?packageIterator(x,start,thunk,opts):thunk())}maybeRealpath(realpath,absoluteStart,opts,(function(err,realStart){err?cb(err):init(realStart)}))};